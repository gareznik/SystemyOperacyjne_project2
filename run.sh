#!/bin/bash

# ==========================================
# НАСТРОЙКИ
# ==========================================
ITERATIONS=10  # Сколько раз прогонять каждый сценарий (для точности среднего)
APP="./simulation"

# Компиляция
echo "Компиляция проекта..."
g++ -o simulation main.cpp -lncurses -lpthread
if [ $? -ne 0 ]; then echo "Ошибка компиляции!"; exit 1; fi

# ==========================================
# ФУНКЦИЯ ТЕСТИРОВАНИЯ
# ==========================================
run_scenario() {
    TEST_NAME=$1
    DURATION=$2
    shift 2
    INPUT_DATA="$@"

    echo "----------------------------------------------------------------"
    echo "Запуск сценария: '$TEST_NAME' ($ITERATIONS раз по ${DURATION}сек)..."
    
    SUM_SERVED=0
    SUM_REJECTED=0
    
    for (( i=1; i<=ITERATIONS; i++ ))
    do
        # Запуск одной симуляции
        timeout --signal=SIGINT ${DURATION}s $APP > temp_run.log 2>&1 << EOF
$INPUT_DATA
EOF
        
        # Парсинг результатов
        SERVED=$(grep "Wszyscy ludzie:" temp_run.log | awk '{print $NF}')
        REJECTED=$(grep "Wszystkie odrzucenia:" temp_run.log | awk '{print $NF}')
        
        SERVED=${SERVED:-0}
        REJECTED=${REJECTED:-0}

        SUM_SERVED=$((SUM_SERVED + SERVED))
        SUM_REJECTED=$((SUM_REJECTED + REJECTED))
        
        echo -n "."
    done
    echo "" 

    AVG_SERVED=$((SUM_SERVED / ITERATIONS))
    AVG_REJECTED=$((SUM_REJECTED / ITERATIONS))

    echo "ИТОГ ПО '$TEST_NAME':"
    echo "  > Среднее кол-во обслуженных: $AVG_SERVED"
    echo "  > Среднее кол-во отказов:     $AVG_REJECTED"
}

# ==========================================
# СЦЕНАРИИ ТЕСТИРОВАНИЯ
# ==========================================
# ИНСТРУКЦИЯ ПО ИЗМЕНЕНИЮ ЦИФР:
# -----------------------------
# Строка 1: Столы (2-местные)  Столы (4-местные)  Столы (6-местные)
# Строка 2: Овощи  Мясо  Хлеб  Одноразовые_приборы
# Строка 3: Вилки  Ножи  Ложки
# Строка 4: Режим_доставки(1=Fix,2=Smart)  Время_доставки(сек)  Время_мойки(сек)  Мин_появление(сек)  Макс_появление(сек)
# Строка 5: Шанс_на_вынос(%)

# --- СЦЕНАРИЙ 1: ОБЫЧНЫЙ ДЕНЬ ---
run_scenario "Normal Day" 5 \
    5 5 5 \
    50 50 50 50 \
    20 20 20 \
    2 2 0.5 0.2 0.5 \
    30

# --- СЦЕНАРИЙ 2: ДЕФИЦИТ ПРИБОРОВ ---
# Здесь мы ставим всего по 2 вилки, ножа и ложки.
# Мойка медленная (1.0 сек). Ожидаем много отказов.
run_scenario "Cutlery Crisis" 5 \
    5 5 5 \
    50 50 50 50 \
    2 2 2 \
    2 2 1.0 0.2 0.5 \
    30

# --- СЦЕНАРИЙ 3: ТОЛЬКО ВЫНОС (FAST FOOD) ---
# Мало столов (по 1), но много одноразовых приборов (200).
# Шанс выноса 90%. Клиенты идут очень быстро (0.1 сек).
run_scenario "Fast Food Takeout" 5 \
    1 1 1 \
    50 50 50 200 \
    10 10 10 \
    2 2 0.5 0.1 0.2 \
    90

# --- СЦЕНАРИЙ 4: ПЕРЕБОИ С ПОСТАВКАМИ ---
# Режим доставки 1 (глупый), доставка едет очень долго (8 сек).
# Склад маленький (по 10 продуктов). Ожидаем голод.
run_scenario "Supply Issues" 5 \
    5 5 5 \
    10 10 10 20 \
    20 20 20 \
    1 8 0.5 0.2 0.5 \
    30

# Чистка временных файлов
rm temp_run.log
echo "----------------------------------------------------------------"
echo "Все тесты завершены."